<?xml version="1.0" encoding="utf-8"?>
<Page x:Class="Expense_Flow.Views.Projects.ProjectsPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:models="using:Expense_Flow.Models"
      xmlns:converters="using:Expense_Flow.Converters"
      xmlns:local="using:Expense_Flow.ViewModels"
      mc:Ignorable="d">

    <Page.Resources>
        <converters:CurrencySymbolConverter x:Key="CurrencySymbolConverter"/>
        <converters:CurrencyFormatterConverter x:Key="CurrencyFormatterConverter"/>
    </Page.Resources>

    <Grid x:Name="RootGrid">
        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup>
                <!-- Compact -->
                <VisualState>
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="RootGrid.Padding" Value="16"/>
                        <Setter Target="ShowArchivedToggle.Visibility" Value="Collapsed"/>
                    </VisualState.Setters>
                </VisualState>
                
                <!-- Medium -->
                <VisualState>
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="640" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="RootGrid.Padding" Value="24"/>
                        <Setter Target="ShowArchivedToggle.Visibility" Value="Visible"/>
                    </VisualState.Setters>
                </VisualState>
                
                <!-- Large -->
                <VisualState>
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1007" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="RootGrid.Padding" Value="32,24,32,32"/>
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Header Section -->
        <Grid Grid.Row="0" Margin="0,0,0,24">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Spacing="8">
                <TextBlock Text="Projects"
                           Style="{StaticResource PageTitleTextStyle}" />
                <TextBlock Text="Organize and track expenses by projects"
                           Style="{StaticResource BodyTextBlockStyle}"
                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                           TextWrapping="Wrap" />
            </StackPanel>

            <StackPanel Grid.Column="1"
                        Orientation="Horizontal"
                        Spacing="12"
                        VerticalAlignment="Center">
                <ToggleSwitch x:Name="ShowArchivedToggle"
                              Header="Archived"
                              IsOn="{x:Bind ViewModel.ShowArchived, Mode=TwoWay}"
                              Toggled="ShowArchived_Toggled" />
                <Button Content="Add Group"
                        Style="{StaticResource PrimaryButtonStyle}"
                        Click="AddProjectGroup_Click">
                    <Button.KeyboardAccelerators>
                        <KeyboardAccelerator Key="G" Modifiers="Control" />
                    </Button.KeyboardAccelerators>
                </Button>
                <Button Content="Add Project"
                        Style="{StaticResource PrimaryButtonStyle}"
                        Click="AddProject_Click">
                    <Button.KeyboardAccelerators>
                        <KeyboardAccelerator Key="N" Modifiers="Control" />
                    </Button.KeyboardAccelerators>
                </Button>
            </StackPanel>
        </Grid>

        <!-- Search Bar -->
        <Border Grid.Row="1"
                Background="{ThemeResource AcrylicInAppFillColorDefaultBrush}"
                CornerRadius="12"
                Padding="16"
                Margin="0,0,0,16"
                Translation="0,0,8">
            <TextBox PlaceholderText="Search projects..."
                     Text="{x:Bind ViewModel.SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                     BorderThickness="0"
                     Background="Transparent">
                <TextBox.KeyboardAccelerators>
                    <KeyboardAccelerator Key="F" Modifiers="Control" />
                </TextBox.KeyboardAccelerators>
            </TextBox>
        </Border>

        <!-- Filter Tabs -->
        <Border Grid.Row="2"
                Background="{ThemeResource AcrylicInAppFillColorDefaultBrush}"
                CornerRadius="12"
                Padding="12"
                Margin="0,0,0,24"
                Translation="0,0,8">
            <StackPanel Orientation="Horizontal" Spacing="12">
                <Button x:Name="FilterAllButton" Content="All Projects" Tag="All"
                        Style="{StaticResource PrimaryButtonStyle}"
                        Click="FilterProjects_Click"
                        Padding="16,8"/>
                <Button x:Name="FilterActiveButton" Content="Active" Tag="Active"
                        Click="FilterProjects_Click"
                        Padding="16,8"/>
                <Button x:Name="FilterDefaultButton" Content="Default" Tag="Default"
                        Click="FilterProjects_Click"
                        Padding="16,8"/>
            </StackPanel>
        </Border>

        <!-- Content -->
        <Grid Grid.Row="3">
            <!-- Loading Indicator -->
            <ProgressRing IsActive="{x:Bind ViewModel.IsBusy, Mode=OneWay}"
                          Width="50" Height="50"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"
                          Visibility="{x:Bind ViewModel.IsBusy, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}" />

            <!-- Error Message -->
            <InfoBar Severity="Error"
                   IsOpen="{x:Bind ViewModel.HasErrors, Mode=OneWay}"
                   Title="Error"
                   Message="{x:Bind ViewModel.ErrorMessage, Mode=OneWay}"
                   Margin="0,0,0,16"
                   VerticalAlignment="Top"/>

            <!-- Empty State -->
            <Border Style="{StaticResource StatCardStyle}"
                    Background="{ThemeResource AcrylicInAppFillColorDefaultBrush}"
                    Translation="0,0,16"
                    Visibility="{x:Bind ViewModel.FilteredProjects.Count, Mode=OneWay, Converter={StaticResource CountToVisibilityConverter}}">
                <StackPanel Spacing="20" Padding="48">
                    <Border Background="{StaticResource PurpleGradientBrush}"
                            Width="80" Height="80"
                            CornerRadius="40"
                            HorizontalAlignment="Center">
                        <FontIcon Glyph="&#xE8F1;" FontSize="40" Foreground="White" />
                    </Border>
                    <TextBlock Text="No projects yet"
                               Style="{StaticResource SectionTitleTextStyle}"
                               HorizontalAlignment="Center" />
                    <TextBlock Text="Create projects to organize and track your expenses with detailed budgets and analytics"
                               Style="{StaticResource BodyTextBlockStyle}"
                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                               HorizontalAlignment="Center"
                               TextWrapping="Wrap"
                               TextAlignment="Center"
                               MaxWidth="400" />
                    <Button Content="Add Your First Project"
                            Style="{StaticResource PrimaryButtonStyle}"
                            HorizontalAlignment="Center"
                            Click="AddProject_Click"/>
                </StackPanel>
            </Border>

            <!-- Projects Grouped by Sections -->
            <ScrollViewer Visibility="{x:Bind ViewModel.FilteredProjects.Count, Mode=OneWay, Converter={StaticResource InverseCountToVisibilityConverter}}">
                <ItemsRepeater ItemsSource="{x:Bind ViewModel.GroupSections, Mode=OneWay}">
                    <ItemsRepeater.Layout>
                        <StackLayout Spacing="24"/>
                    </ItemsRepeater.Layout>
                    <ItemsRepeater.ItemTemplate>
                        <DataTemplate x:DataType="local:ProjectGroupSection">
                            <StackPanel Spacing="12">
                                <!-- Group Section Header -->
                                <Border Background="{ThemeResource AcrylicInAppFillColorDefaultBrush}"
                                        CornerRadius="12"
                                        Padding="16"
                                        Translation="0,0,8">
                                    <Border.Shadow>
                                        <ThemeShadow/>
                                    </Border.Shadow>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <Border Grid.Column="0"
                                                Background="{StaticResource PurpleGradientBrush}"
                                                Width="40" Height="40"
                                                CornerRadius="10"
                                                Margin="0,0,12,0">
                                            <FontIcon Glyph="&#xF168;" Foreground="White" FontSize="18"/>
                                        </Border>

                                        <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="2">
                                            <TextBlock Text="{x:Bind GroupName}"
                                                       FontWeight="Bold"
                                                       FontSize="16"/>
                                            <TextBlock Text="{x:Bind GroupDescription}"
                                                       Style="{StaticResource CaptionTextBlockStyle}"
                                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                       TextTrimming="CharacterEllipsis"
                                                       MaxLines="1"/>
                                        </StackPanel>

                                        <!-- Project count badge -->
                                        <Border Grid.Column="2"
                                                Background="{StaticResource PrimaryGradientBrush}"
                                                CornerRadius="12"
                                                Padding="10,4"
                                                VerticalAlignment="Center"
                                                Margin="0,0,12,0">
                                            <TextBlock Foreground="White" FontSize="12" FontWeight="SemiBold">
                                                <Run Text="{x:Bind Projects.Count}"/>
                                                <Run Text="projects"/>
                                            </TextBlock>
                                        </Border>

                                        <!-- Edit / Delete buttons (only for real groups, not "Others") -->
                                        <StackPanel Grid.Column="3" 
                                                    Orientation="Horizontal" 
                                                    Spacing="4" 
                                                    VerticalAlignment="Center"
                                                    Visibility="{x:Bind IsDefaultSection, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                            <Button Style="{StaticResource IconButtonStyle}"
                                                    Width="36" Height="36"
                                                    CornerRadius="8"
                                                    ToolTipService.ToolTip="Edit Group"
                                                    Click="EditProjectGroup_Click"
                                                    Tag="{x:Bind Group}">
                                                <FontIcon Glyph="&#xE70F;" FontSize="14"/>
                                            </Button>
                                            <Button Style="{StaticResource IconButtonStyle}"
                                                    Width="36" Height="36"
                                                    CornerRadius="8"
                                                    ToolTipService.ToolTip="Delete Group"
                                                    Click="DeleteProjectGroup_Click"
                                                    Tag="{x:Bind Group}">
                                                <FontIcon Glyph="&#xE74D;" FontSize="14" Foreground="{ThemeResource SystemFillColorCriticalBrush}"/>
                                            </Button>
                                        </StackPanel>
                                    </Grid>
                                </Border>

                                <!-- Projects Grid within this group -->
                                <ItemsRepeater ItemsSource="{x:Bind Projects}">
                                    <ItemsRepeater.Layout>
                                        <UniformGridLayout MinItemWidth="380"
                                                           MinItemHeight="360"
                                                           ItemsStretch="Fill" />
                                    </ItemsRepeater.Layout>
                                    <ItemsRepeater.ItemTemplate>
                                        <DataTemplate x:DataType="models:Project">
                                            <Grid Margin="8">
                                                <Border CornerRadius="16"
                                                        Translation="0,0,16">
                                                    <Border.Shadow>
                                                        <ThemeShadow />
                                                    </Border.Shadow>
                                                    
                                                    <Grid>
                                                        <Grid.RowDefinitions>
                                                            <RowDefinition Height="Auto"/>
                                                            <RowDefinition Height="*"/>
                                                        </Grid.RowDefinitions>

                                                        <!-- Gradient Header -->
                                                        <Border Grid.Row="0"
                                                                Background="{StaticResource PurpleGradientBrush}"
                                                                CornerRadius="16,16,0,0"
                                                                Height="100">
                                                            <Grid Padding="20">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                    <ColumnDefinition Width="*"/>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                </Grid.ColumnDefinitions>

                                                                <Border Grid.Column="0"
                                                                        Background="#40FFFFFF"
                                                                        Width="56" Height="56"
                                                                        CornerRadius="16"
                                                                        VerticalAlignment="Center">
                                                                    <FontIcon Glyph="&#xE8F1;" 
                                                                            Foreground="White" 
                                                                            FontSize="28" />
                                                                </Border>

                                                                <StackPanel Grid.Column="1" 
                                                                          Margin="16,0,0,0"
                                                                          VerticalAlignment="Center"
                                                                          Spacing="4">
                                                                    <TextBlock Text="{x:Bind Name}"
                                                                             Foreground="White"
                                                                             FontSize="18"
                                                                             FontWeight="Bold"
                                                                             TextWrapping="NoWrap"
                                                                             TextTrimming="CharacterEllipsis" />
                                                                    <TextBlock Text="{x:Bind Description}"
                                                                             Foreground="White"
                                                                             Opacity="0.9"
                                                                             FontSize="13"
                                                                             TextWrapping="NoWrap"
                                                                             TextTrimming="CharacterEllipsis"
                                                                             Visibility="{x:Bind Description, Converter={StaticResource NullToVisibilityConverter}}" />
                                                                </StackPanel>

                                                                <StackPanel Grid.Column="2" 
                                                                          VerticalAlignment="Top"
                                                                          Spacing="8">
                                                                    <Border Background="#40FF0000"
                                                                          CornerRadius="12"
                                                                          Padding="8,4"
                                                                          Visibility="{x:Bind IsArchived}">
                                                                        <TextBlock Text="Archived"
                                                                                 Foreground="White"
                                                                                 FontSize="11"
                                                                                 FontWeight="SemiBold" />
                                                                    </Border>
                                                                    <Border Background="#40FFD700"
                                                                          CornerRadius="12"
                                                                          Padding="8,4"
                                                                          Visibility="{x:Bind IsDefault}">
                                                                        <TextBlock Text="Default"
                                                                                 Foreground="White"
                                                                                 FontSize="11"
                                                                                 FontWeight="SemiBold" />
                                                                    </Border>
                                                                </StackPanel>
                                                            </Grid>
                                                        </Border>

                                                        <!-- Card Content -->
                                                        <Border Grid.Row="1"
                                                                Background="{ThemeResource AcrylicInAppFillColorDefaultBrush}"
                                                                CornerRadius="0,0,16,16"
                                                                Padding="20">
                                                            <Grid RowSpacing="16">
                                                                <Grid.RowDefinitions>
                                                                    <RowDefinition Height="Auto"/>
                                                                    <RowDefinition Height="Auto"/>
                                                                    <RowDefinition Height="Auto"/>
                                                                </Grid.RowDefinitions>

                                                                <!-- Budget Progress -->
                                                                <StackPanel Grid.Row="0" Spacing="8">
                                                                    <Grid>
                                                                        <TextBlock Text="Monthly Budget Usage"
                                                                                 FontSize="12"
                                                                                 FontWeight="SemiBold"
                                                                                 Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                                                        <StackPanel Orientation="Horizontal" 
                                                                                  HorizontalAlignment="Right" 
                                                                                  Spacing="4">
                                                                            <TextBlock Text="{x:Bind CurrentMonthExpenses, Converter={StaticResource CurrencyFormatterConverter}}"
                                                                                     FontSize="12"
                                                                                     FontWeight="SemiBold"
                                                                                     Foreground="{StaticResource PrimaryBrush}"/>
                                                                            <TextBlock Text=" / "
                                                                                     FontSize="12"
                                                                                     FontWeight="SemiBold"
                                                                                     Foreground="{StaticResource PrimaryBrush}"/>
                                                                            <TextBlock Text="{x:Bind MonthlyBudget, Converter={StaticResource CurrencyFormatterConverter}}"
                                                                                     FontSize="12"
                                                                                     FontWeight="SemiBold"
                                                                                     Foreground="{StaticResource PrimaryBrush}"/>
                                                                        </StackPanel>
                                                                    </Grid>
                                                                    <ProgressBar Value="{x:Bind MonthlyBudgetUsagePercentage}"
                                                                               Maximum="100"
                                                                               Height="8"
                                                                               CornerRadius="4"
                                                                               Foreground="{StaticResource SuccessGradientBrush}"
                                                                               Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"/>
                                                                </StackPanel>

                                                                <!-- Expense Stats -->
                                                                <Grid Grid.Row="1" ColumnSpacing="12">
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="*"/>
                                                                        <ColumnDefinition Width="*"/>
                                                                        <ColumnDefinition Width="*"/>
                                                                    </Grid.ColumnDefinitions>

                                                                    <Border Grid.Column="0"
                                                                          Background="{StaticResource PrimaryGradientBrush}"
                                                                          CornerRadius="12"
                                                                          Padding="12"
                                                                          Height="80">
                                                                        <StackPanel Spacing="6" VerticalAlignment="Center">
                                                                            <FontIcon Glyph="&#xE8C7;" 
                                                                                    Foreground="White"
                                                                                    FontSize="20"
                                                                                    Opacity="0.9"/>
                                                                            <TextBlock Text="Total"
                                                                                     FontSize="10"
                                                                                     Foreground="White"
                                                                                     Opacity="0.8"
                                                                                     FontWeight="SemiBold"
                                                                                     TextAlignment="Center"/>
                                                                            <TextBlock Text="{x:Bind TotalExpenses, Converter={StaticResource CurrencyFormatterConverter}}"
                                                                                     FontSize="14"
                                                                                     FontWeight="Bold"
                                                                                     Foreground="White"
                                                                                     TextAlignment="Center"/>
                                                                        </StackPanel>
                                                                    </Border>

                                                                    <Border Grid.Column="1"
                                                                          Background="{StaticResource SuccessGradientBrush}"
                                                                          CornerRadius="12"
                                                                          Padding="12"
                                                                          Height="80">
                                                                        <StackPanel Spacing="6" VerticalAlignment="Center">
                                                                            <FontIcon Glyph="&#xE787;" 
                                                                                    Foreground="White"
                                                                                    FontSize="20"
                                                                                    Opacity="0.9"/>
                                                                            <TextBlock Text="This Month"
                                                                                     FontSize="10"
                                                                                     Foreground="White"
                                                                                     Opacity="0.8"
                                                                                     FontWeight="SemiBold"
                                                                                     TextAlignment="Center"/>
                                                                            <TextBlock Text="{x:Bind CurrentMonthExpenses, Converter={StaticResource CurrencyFormatterConverter}}"
                                                                                     FontSize="14"
                                                                                     FontWeight="Bold"
                                                                                     Foreground="White"
                                                                                     TextAlignment="Center"/>
                                                                        </StackPanel>
                                                                    </Border>

                                                                    <Border Grid.Column="2"
                                                                          Background="{StaticResource WarningGradientBrush}"
                                                                          CornerRadius="12"
                                                                          Padding="12"
                                                                          Height="80">
                                                                        <StackPanel Spacing="6" VerticalAlignment="Center">
                                                                            <FontIcon Glyph="&#xE823;" 
                                                                                    Foreground="White"
                                                                                    FontSize="20"
                                                                                    Opacity="0.9"/>
                                                                            <TextBlock Text="Last Month"
                                                                                     FontSize="10"
                                                                                     Foreground="White"
                                                                                     Opacity="0.8"
                                                                                     FontWeight="SemiBold"
                                                                                     TextAlignment="Center"/>
                                                                            <TextBlock Text="{x:Bind LastMonthExpenses, Converter={StaticResource CurrencyFormatterConverter}}"
                                                                                     FontSize="14"
                                                                                     FontWeight="Bold"
                                                                                     Foreground="White"
                                                                                     TextAlignment="Center"/>
                                                                        </StackPanel>
                                                                    </Border>
                                                                </Grid>

                                                                <!-- Actions -->
                                                                <Grid Grid.Row="2" ColumnSpacing="8">
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="*"/>
                                                                        <ColumnDefinition Width="Auto"/>
                                                                        <ColumnDefinition Width="Auto"/>
                                                                    </Grid.ColumnDefinitions>

                                                                    <Button Grid.Column="0"
                                                                          Style="{StaticResource PrimaryButtonStyle}"
                                                                          HorizontalAlignment="Stretch"
                                                                          Click="ViewProjectDetails_Click"
                                                                          Tag="{x:Bind}">
                                                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                                                            <FontIcon Glyph="&#xE8A7;" FontSize="14"/>
                                                                            <TextBlock Text="View Details"/>
                                                                        </StackPanel>
                                                                    </Button>

                                                                    <Button Grid.Column="1"
                                                                          Style="{StaticResource IconButtonStyle}"
                                                                          Width="40" Height="40"
                                                                          CornerRadius="12"
                                                                          ToolTipService.ToolTip="Edit Project"
                                                                          Click="EditProject_Click"
                                                                          Tag="{x:Bind}">
                                                                        <FontIcon Glyph="&#xE70F;" FontSize="16" />
                                                                    </Button>
                                                                    
                                                                    <Button Grid.Column="2"
                                                                          Style="{StaticResource IconButtonStyle}"
                                                                          Width="40" Height="40"
                                                                          CornerRadius="12"
                                                                          ToolTipService.ToolTip="Archive Project"
                                                                          Click="ArchiveProject_Click"
                                                                          Tag="{x:Bind}">
                                                                        <FontIcon Glyph="&#xE7B8;" FontSize="16" />
                                                                    </Button>
                                                                </Grid>
                                                            </Grid>
                                                        </Border>
                                                    </Grid>
                                                </Border>
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsRepeater.ItemTemplate>
                                </ItemsRepeater>

                                <!-- Empty group message -->
                                <Border Background="{ThemeResource AcrylicInAppFillColorDefaultBrush}"
                                        CornerRadius="12"
                                        Padding="24"
                                        Visibility="{x:Bind Projects.Count, Converter={StaticResource CountToVisibilityConverter}}">
                                    <TextBlock Text="No projects in this group"
                                               Style="{StaticResource CaptionTextBlockStyle}"
                                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                               HorizontalAlignment="Center"/>
                                </Border>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsRepeater.ItemTemplate>
                </ItemsRepeater>
            </ScrollViewer>
        </Grid>
    </Grid>
</Page>
