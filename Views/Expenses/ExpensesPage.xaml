<?xml version="1.0" encoding="utf-8"?>
<Page x:Class="Expense_Flow.Views.Expenses.ExpensesPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:models="using:Expense_Flow.Models"
      mc:Ignorable="d">

    <Grid x:Name="RootGrid">
        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup>
                <!-- Compact -->
                <VisualState>
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="RootGrid.Padding" Value="16"/>
                        <Setter Target="FiltersGrid.ColumnDefinitions[0].Width" Value="*"/>
                        <Setter Target="FiltersGrid.ColumnDefinitions[1].Width" Value="0"/>
                        <Setter Target="ClearFiltersButton.Visibility" Value="Collapsed"/>
                        <Setter Target="HeaderActions.Orientation" Value="Vertical"/>
                        <Setter Target="HeaderActions.Spacing" Value="8"/>
                    </VisualState.Setters>
                </VisualState>
                
                <!-- Medium -->
                <VisualState>
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="640" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="RootGrid.Padding" Value="24"/>
                        <Setter Target="FiltersGrid.ColumnDefinitions[0].Width" Value="2*"/>
                        <Setter Target="FiltersGrid.ColumnDefinitions[1].Width" Value="Auto"/>
                        <Setter Target="ClearFiltersButton.Visibility" Value="Visible"/>
                    </VisualState.Setters>
                </VisualState>
                
                <!-- Large -->
                <VisualState>
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1007" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="RootGrid.Padding" Value="32,24,32,32"/>
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Header Section -->
        <Grid Grid.Row="0" Margin="0,0,0,24">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Spacing="8">
                <TextBlock Text="Expenses"
                           Style="{StaticResource PageTitleTextStyle}" />
                <TextBlock Text="Track and manage all your expenses"
                           Style="{StaticResource BodyTextBlockStyle}"
                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                           TextWrapping="Wrap" />
            </StackPanel>

            <StackPanel x:Name="HeaderActions"
                        Grid.Column="1"
                        Orientation="Horizontal"
                        Spacing="12"
                        VerticalAlignment="Center">
                <Button Content="Add Expense"
                        Style="{StaticResource PrimaryButtonStyle}"
                        Click="AddExpense_Click">
                    <Button.KeyboardAccelerators>
                        <KeyboardAccelerator Key="N" Modifiers="Control" />
                    </Button.KeyboardAccelerators>
                </Button>
            </StackPanel>
        </Grid>

        <!-- Filters Bar -->
        <Border Grid.Row="1"
                Background="{ThemeResource AcrylicInAppFillColorDefaultBrush}"
                CornerRadius="12"
                Padding="16"
                Margin="0,0,0,24"
                Translation="0,0,8">
            <Grid x:Name="FiltersGrid" ColumnSpacing="16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <ComboBox Grid.Column="0"
                          PlaceholderText="Filter by Project"
                          ItemsSource="{x:Bind ViewModel.Projects, Mode=OneWay}"
                          DisplayMemberPath="Name"
                          SelectedItem="{x:Bind ViewModel.SelectedProject, Mode=TwoWay}"
                          HorizontalAlignment="Stretch"
                          Style="{StaticResource ModernComboBoxStyle}" />

                <Button x:Name="ClearFiltersButton"
                        Grid.Column="1"
                        Content="Clear Filters"
                        Command="{x:Bind ViewModel.ClearFiltersCommand}" />
            </Grid>
        </Border>

        <!-- Content -->
        <Grid Grid.Row="2">
            <!-- Loading Indicator -->
            <ProgressRing IsActive="{x:Bind ViewModel.IsBusy, Mode=OneWay}"
                          Width="50"
                          Height="50"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"
                          Visibility="{x:Bind ViewModel.IsBusy, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}" />

            <!-- Error Message -->
            <InfoBar Severity="Error"
                     IsOpen="{x:Bind ViewModel.HasErrors, Mode=OneWay}"
                     Title="Error"
                     Message="{x:Bind ViewModel.ErrorMessage, Mode=OneWay}"
                     Margin="0,0,0,16"
                     VerticalAlignment="Top" />

            <!-- Empty State -->
            <Border Style="{StaticResource StatCardStyle}"
                    Background="{ThemeResource AcrylicInAppFillColorDefaultBrush}"
                    Translation="0,0,16"
                    Visibility="{x:Bind ViewModel.Expenses.Count, Mode=OneWay, Converter={StaticResource CountToVisibilityConverter}}">
                <StackPanel Spacing="20" Padding="48">
                    <Border Background="{StaticResource WarningGradientBrush}"
                            Width="80"
                            Height="80"
                            CornerRadius="40"
                            HorizontalAlignment="Center">
                        <FontIcon Glyph="&#xE8C7;" FontSize="40" Foreground="White" />
                    </Border>
                    <TextBlock Text="No expenses yet"
                               Style="{StaticResource SectionTitleTextStyle}"
                               HorizontalAlignment="Center" />
                    <TextBlock Text="Start tracking your expenses to get insights"
                               Style="{StaticResource BodyTextBlockStyle}"
                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                               HorizontalAlignment="Center"
                               TextWrapping="Wrap"
                               TextAlignment="Center"
                               MaxWidth="400" />
                    <Button Content="Add Your First Expense"
                            Style="{StaticResource PrimaryButtonStyle}"
                            HorizontalAlignment="Center"
                            Click="AddExpense_Click" />
                </StackPanel>
            </Border>

            <!-- Expenses List -->
            <ScrollViewer Visibility="{x:Bind ViewModel.Expenses.Count, Mode=OneWay, Converter={StaticResource InverseCountToVisibilityConverter}}">
                <ItemsRepeater ItemsSource="{x:Bind ViewModel.Expenses, Mode=OneWay}">
                    <ItemsRepeater.Layout>
                        <StackLayout Spacing="12" />
                    </ItemsRepeater.Layout>
                    <ItemsRepeater.ItemTemplate>
                        <DataTemplate x:DataType="models:Expense">
                            <Border Background="{ThemeResource AcrylicInAppFillColorDefaultBrush}"
                                    Style="{StaticResource CardStyle}"
                                    Translation="0,0,8">
                                <Grid ColumnSpacing="20">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <Border Grid.Column="0"
                                            Background="{StaticResource WarningGradientBrush}"
                                            Width="56"
                                            Height="56"
                                            CornerRadius="16">
                                        <FontIcon Glyph="&#xE8C7;" Foreground="White" FontSize="28" />
                                    </Border>

                                    <StackPanel Grid.Column="1" Spacing="6" VerticalAlignment="Center">
                                        <TextBlock Text="{x:Bind InvoiceNumber}"
                                                   Style="{StaticResource CardTitleTextStyle}" />
                                        <TextBlock Text="{x:Bind CreatedAt}"
                                                   Style="{StaticResource CaptionTextBlockStyle}"
                                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                                    </StackPanel>

                                    <StackPanel Grid.Column="2" VerticalAlignment="Center" HorizontalAlignment="Right">
                                        <TextBlock Text="{x:Bind InvoiceAmount}"
                                                   Style="{StaticResource StatValueTextStyle}"
                                                   FontSize="22"
                                                   Foreground="{StaticResource WarningBrush}" />
                                    </StackPanel>

                                    <StackPanel Grid.Column="3"
                                                Orientation="Horizontal"
                                                Spacing="8"
                                                VerticalAlignment="Center">
                                        <Button Style="{StaticResource IconButtonStyle}"
                                                ToolTipService.ToolTip="Edit"
                                                Click="EditExpense_Click"
                                                Tag="{x:Bind}">
                                            <FontIcon Glyph="&#xE70F;" FontSize="16" />
                                        </Button>
                                        <Button Style="{StaticResource IconButtonStyle}"
                                                ToolTipService.ToolTip="Delete"
                                                Click="DeleteExpense_Click"
                                                Tag="{x:Bind}">
                                            <FontIcon Glyph="&#xE74D;" FontSize="16" Foreground="{StaticResource ErrorBrush}" />
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsRepeater.ItemTemplate>
                </ItemsRepeater>
            </ScrollViewer>
        </Grid>

        <!-- Total Bar -->
        <Border Grid.Row="3"
                Background="{StaticResource PrimaryGradientBrush}"
                CornerRadius="12"
                Padding="24,16"
                Margin="0,24,0,0"
                Translation="0,0,16">
            <Grid>
                <TextBlock Text="Total Expenses"
                           Foreground="White"
                           FontSize="16"
                           FontWeight="SemiBold"
                           VerticalAlignment="Center" />
                <TextBlock Text="{x:Bind ViewModel.TotalAmount, Mode=OneWay}"
                           Foreground="White"
                           FontSize="28"
                           FontWeight="Bold"
                           HorizontalAlignment="Right"
                           VerticalAlignment="Center" />
            </Grid>
        </Border>
    </Grid>
</Page>